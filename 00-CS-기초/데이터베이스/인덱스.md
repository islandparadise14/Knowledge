---
tags: [CS, ë°ì´í„°ë² ì´ìŠ¤, ì¸ë±ìŠ¤, SQLite, Room, ì„±ëŠ¥]
---

# ì¸ë±ìŠ¤

## ğŸ’¡ í•µì‹¬ ê°œë…

ì¸ë±ìŠ¤(Index)ëŠ” í…Œì´ë¸”ì˜ ê²€ìƒ‰ ì†ë„ë¥¼ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•œ ìë£Œêµ¬ì¡°ë¡œ, ì±…ì˜ ìƒ‰ì¸ê³¼ ê°™ì€ ì—­í• ì„ í•œë‹¤. SQLiteì—ì„œëŠ” B-Tree ê¸°ë°˜ìœ¼ë¡œ ì¸ë±ìŠ¤ë¥¼ êµ¬í˜„í•˜ë©°, Roomì—ì„œëŠ” `@Index` ì–´ë…¸í…Œì´ì…˜ì´ë‚˜ `@Entity`ì˜ `indices` ì†ì„±ìœ¼ë¡œ ì¸ë±ìŠ¤ë¥¼ ì„ ì–¸í•œë‹¤. ì½ê¸° ì„±ëŠ¥ì€ í–¥ìƒë˜ì§€ë§Œ ì“°ê¸° ì„±ëŠ¥ê³¼ ì €ì¥ ê³µê°„ì— ì˜¤ë²„í—¤ë“œê°€ ë°œìƒí•œë‹¤.

## ğŸ“Œ ì™œ í•„ìš”í•œê°€?

Android ì•±ì—ì„œ ëŒ€ëŸ‰ì˜ ë¡œì»¬ ë°ì´í„°ë¥¼ ë‹¤ë£° ë•Œ (ì±„íŒ… ë©”ì‹œì§€, ë¡œê·¸, ìºì‹œ ë“±), ì¸ë±ìŠ¤ ì—†ì´ëŠ” ë§¤ë²ˆ í’€ í…Œì´ë¸” ìŠ¤ìº”ì´ ë°œìƒí•´ UIê°€ ë²„ë²…ì¼ ìˆ˜ ìˆë‹¤. ì ì ˆí•œ ì¸ë±ìŠ¤ ì„¤ê³„ê°€ ì•± ì„±ëŠ¥ì˜ í•µì‹¬ì´ë‹¤.

## ğŸ” ìì„¸íˆ

### ì¸ë±ìŠ¤ì˜ ë™ì‘ ì›ë¦¬

```
ì¸ë±ìŠ¤ ì—†ì´ ê²€ìƒ‰ (Full Table Scan):
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚ 1 â”‚ ê¹€ì² ìˆ˜ â”‚ 25  â”‚  â† í™•ì¸
â”‚ 2 â”‚ ì´ì˜í¬ â”‚ 30  â”‚  â† í™•ì¸
â”‚ 3 â”‚ ë°•ë¯¼ìˆ˜ â”‚ 28  â”‚  â† í™•ì¸ âœ“ ì°¾ìŒ
â”‚ 4 â”‚ ìµœì§€ì› â”‚ 22  â”‚  â† í™•ì¸
â”‚ ...â”‚ ...   â”‚ ... â”‚  â† ëª¨ë“  í–‰ í™•ì¸ (O(n))
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜

ì¸ë±ìŠ¤ë¡œ ê²€ìƒ‰ (B-Tree):
        [ë°•]
       /    \
    [ê¹€]    [ì´,ìµœ]
     â†“       â†“
  row 1   row 2,4

â†’ "ë°•ë¯¼ìˆ˜" ê²€ìƒ‰: O(log n) ë§Œì— ì°¾ìŒ
```

### Roomì—ì„œ ì¸ë±ìŠ¤ ì„ ì–¸

```kotlin
// ë°©ë²• 1: @Entityì˜ indices ì†ì„±
@Entity(
    tableName = "message",
    indices = [
        Index(value = ["chatRoomId"]),                    // ë‹¨ì¼ ì¸ë±ìŠ¤
        Index(value = ["senderId", "timestamp"]),          // ë³µí•© ì¸ë±ìŠ¤
        Index(value = ["messageId"], unique = true)        // ìœ ë‹ˆí¬ ì¸ë±ìŠ¤
    ]
)
data class Message(
    @PrimaryKey(autoGenerate = true) val id: Long = 0,
    val chatRoomId: Long,
    val senderId: Long,
    val messageId: String,
    val content: String,
    val timestamp: Long
)

// ë°©ë²• 2: @ColumnInfoì™€ í•¨ê»˜ ForeignKeyì— ìë™ ì¸ë±ìŠ¤
@Entity(
    foreignKeys = [ForeignKey(
        entity = ChatRoom::class,
        parentColumns = ["id"],
        childColumns = ["chatRoomId"],
        onDelete = ForeignKey.CASCADE
    )],
    indices = [Index("chatRoomId")]  // FKì—ëŠ” ì¸ë±ìŠ¤ ê¶Œì¥
)
data class Message(
    @PrimaryKey(autoGenerate = true) val id: Long = 0,
    @ColumnInfo(index = true) val chatRoomId: Long,  // ê°œë³„ ì»¬ëŸ¼ ì¸ë±ìŠ¤
    val content: String
)
```

### ì¸ë±ìŠ¤ ì¢…ë¥˜

**ë‹¨ì¼ ì¸ë±ìŠ¤ vs ë³µí•© ì¸ë±ìŠ¤**

```kotlin
// ë‹¨ì¼ ì¸ë±ìŠ¤: í•˜ë‚˜ì˜ ì»¬ëŸ¼
@Entity(indices = [Index("email")])

// ë³µí•© ì¸ë±ìŠ¤: ì—¬ëŸ¬ ì»¬ëŸ¼ (ìˆœì„œê°€ ì¤‘ìš”!)
@Entity(indices = [Index(value = ["lastName", "firstName"])])
```

ë³µí•© ì¸ë±ìŠ¤ì—ì„œ ì»¬ëŸ¼ ìˆœì„œê°€ ì¤‘ìš”í•˜ë‹¤:

```kotlin
// Index(value = ["lastName", "firstName"]) ì¼ ë•Œ

// ì¸ë±ìŠ¤ ì‚¬ìš©ë¨
@Query("SELECT * FROM user WHERE lastName = :last")
@Query("SELECT * FROM user WHERE lastName = :last AND firstName = :first")

// ì¸ë±ìŠ¤ ì‚¬ìš© ì•ˆ ë¨ (ì„ í–‰ ì»¬ëŸ¼ ì—†ì´ í›„í–‰ ì»¬ëŸ¼ë§Œ ê²€ìƒ‰)
@Query("SELECT * FROM user WHERE firstName = :first")
```

**ìœ ë‹ˆí¬ ì¸ë±ìŠ¤**

```kotlin
@Entity(
    indices = [Index(value = ["email"], unique = true)]
)
data class User(
    @PrimaryKey(autoGenerate = true) val id: Long = 0,
    val email: String,  // ì¤‘ë³µ ì‚½ì… ì‹œ ì˜ˆì™¸ ë°œìƒ
    val name: String
)
```

### EXPLAIN QUERY PLANìœ¼ë¡œ ì¸ë±ìŠ¤ í™•ì¸

```kotlin
// ë””ë²„ê·¸ ì‹œ ì¿¼ë¦¬ ê³„íš í™•ì¸
@Query("EXPLAIN QUERY PLAN SELECT * FROM message WHERE chatRoomId = :roomId ORDER BY timestamp DESC")
suspend fun explainQuery(roomId: Long): List<QueryPlanRow>

// ê²°ê³¼ ì˜ˆì‹œ:
// SEARCH TABLE message USING INDEX index_message_chatRoomId (chatRoomId=?)
// â†’ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŒ

// SCAN TABLE message
// â†’ í’€ í…Œì´ë¸” ìŠ¤ìº” (ì¸ë±ìŠ¤ ë¯¸ì‚¬ìš©, ì„±ëŠ¥ ë¬¸ì œ!)
```

### ì¸ë±ìŠ¤ë¥¼ ê±¸ì–´ì•¼ í•  ë•Œ / ë§ì•„ì•¼ í•  ë•Œ

```
âœ… ì¸ë±ìŠ¤ë¥¼ ê±¸ì–´ì•¼ í•  ë•Œ:
- WHERE ì ˆì— ìì£¼ ì‚¬ìš©ë˜ëŠ” ì»¬ëŸ¼
- JOIN ì¡°ê±´ì— ì‚¬ìš©ë˜ëŠ” ì»¬ëŸ¼ (FK)
- ORDER BYì— ì‚¬ìš©ë˜ëŠ” ì»¬ëŸ¼
- ì„ íƒë„(Selectivity)ê°€ ë†’ì€ ì»¬ëŸ¼ (ê³ ìœ ê°’ì´ ë§ì€)

âŒ ì¸ë±ìŠ¤ë¥¼ í”¼í•´ì•¼ í•  ë•Œ:
- í–‰ ìˆ˜ê°€ ë§¤ìš° ì ì€ í…Œì´ë¸” (ìˆ˜ì‹­ ê±´)
- ì‚½ì…/ìˆ˜ì •/ì‚­ì œê°€ ë§¤ìš° ë¹ˆë²ˆí•œ í…Œì´ë¸”
- ì„ íƒë„ê°€ ë‚®ì€ ì»¬ëŸ¼ (ì˜ˆ: boolean, gender)
- ê±°ì˜ ì¡°íšŒí•˜ì§€ ì•ŠëŠ” ì»¬ëŸ¼
```

### ì„±ëŠ¥ ë¹„êµ ì˜ˆì‹œ

```kotlin
// 10ë§Œ ê±´ì˜ ë©”ì‹œì§€ì—ì„œ íŠ¹ì • ì±„íŒ…ë°© ë©”ì‹œì§€ ì¡°íšŒ
@Query("SELECT * FROM message WHERE chatRoomId = :roomId ORDER BY timestamp DESC LIMIT 50")
suspend fun getMessages(roomId: Long): List<Message>

// ì¸ë±ìŠ¤ ì—†ìŒ:  ~150ms (SCAN TABLE)
// ë‹¨ì¼ ì¸ë±ìŠ¤ (chatRoomId):  ~5ms
// ë³µí•© ì¸ë±ìŠ¤ (chatRoomId, timestamp):  ~2ms (ì •ë ¬ê¹Œì§€ ì¸ë±ìŠ¤ë¡œ ì²˜ë¦¬)
```

### ì£¼ì˜ì‚¬í•­

```kotlin
// SQLiteëŠ” ì¿¼ë¦¬ë‹¹ í•˜ë‚˜ì˜ ì¸ë±ìŠ¤ë§Œ ì‚¬ìš©í•œë‹¤
// ë”°ë¼ì„œ ì—¬ëŸ¬ ì¡°ê±´ì´ ìˆìœ¼ë©´ ë³µí•© ì¸ë±ìŠ¤ê°€ íš¨ê³¼ì 

// ë¹„íš¨ìœ¨ì : ë‘ ê°œì˜ ë‹¨ì¼ ì¸ë±ìŠ¤
@Entity(indices = [
    Index("chatRoomId"),
    Index("timestamp")
])

// íš¨ìœ¨ì : í•˜ë‚˜ì˜ ë³µí•© ì¸ë±ìŠ¤
@Entity(indices = [
    Index(value = ["chatRoomId", "timestamp"])
])
```

## ğŸ”— ê´€ë ¨ ê°œë…

- [[00-CS-ê¸°ì´ˆ/ë°ì´í„°ë² ì´ìŠ¤/SQL-ê¸°ì´ˆ|SQL ê¸°ì´ˆ]]
- [[00-CS-ê¸°ì´ˆ/ë°ì´í„°ë² ì´ìŠ¤/ì •ê·œí™”|ì •ê·œí™”]]
- [[00-CS-ê¸°ì´ˆ/ë°ì´í„°ë² ì´ìŠ¤/íŠ¸ëœì­ì…˜-ACID|íŠ¸ëœì­ì…˜ ACID]]
- [[00-CS-ê¸°ì´ˆ/ìë£Œêµ¬ì¡°/íŠ¸ë¦¬|íŠ¸ë¦¬ (B-Tree)]]

## ğŸ“š ë” ë³´ê¸°

- [SQLite Query Planning](https://www.sqlite.org/queryplanner.html)
- [Room Index ë¬¸ì„œ](https://developer.android.com/reference/androidx/room/Index)
- [SQLite EXPLAIN QUERY PLAN](https://www.sqlite.org/eqp.html)

---

**í•µì‹¬ ìš”ì•½:** ì¸ë±ìŠ¤ëŠ” B-Tree ê¸°ë°˜ìœ¼ë¡œ ê²€ìƒ‰ì„ O(n)ì—ì„œ O(log n)ìœ¼ë¡œ ê°œì„ í•˜ë©°, Roomì˜ `@Index`ë¡œ ì„ ì–¸í•˜ë˜, ì“°ê¸° ì˜¤ë²„í—¤ë“œë¥¼ ê³ ë ¤í•´ í•„ìš”í•œ ê³³ì—ë§Œ ì ìš©í•œë‹¤.
