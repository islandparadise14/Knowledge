---
tags: [CS, ë™ì‹œì„±, ê²½ìŸì¡°ê±´, Race-Condition, Android]
---

# ê²½ìŸ ì¡°ê±´ (Race Condition)

## ğŸ’¡ í•µì‹¬ ê°œë…

**ê²½ìŸ ì¡°ê±´(Race Condition)**ì€ ë‘˜ ì´ìƒì˜ ìŠ¤ë ˆë“œ(ë˜ëŠ” ì½”ë£¨í‹´)ê°€ ê³µìœ  ìì›ì— ë™ì‹œì— ì ‘ê·¼í•  ë•Œ, ì‹¤í–‰ ìˆœì„œì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§€ëŠ” ë²„ê·¸ì´ë‹¤. ì½ê¸°-ìˆ˜ì •-ì“°ê¸°(Read-Modify-Write) ì—°ì‚°ì´ ì›ìì ì´ì§€ ì•Šì„ ë•Œ ë°œìƒí•œë‹¤. ì´ ë²„ê·¸ëŠ” ì¬í˜„ì´ ì–´ë µê³  ë””ë²„ê¹…ì´ ê¹Œë‹¤ë¡œì›Œ ë™ì‹œì„± í”„ë¡œê·¸ë˜ë°ì—ì„œ ê°€ì¥ ì£¼ì˜í•´ì•¼ í•  ë¬¸ì œì´ë‹¤.

## ğŸ“Œ ì™œ í•„ìš”í•œê°€?

Androidì—ì„œ ViewModelì˜ ìƒíƒœë¥¼ ì—¬ëŸ¬ ì½”ë£¨í‹´ì´ ë™ì‹œì— ìˆ˜ì •í•˜ê±°ë‚˜, ìºì‹œë¥¼ ì—¬ëŸ¬ ìŠ¤ë ˆë“œì—ì„œ ì ‘ê·¼í•˜ë©´ ê²½ìŸ ì¡°ê±´ì´ ë°œìƒí•œë‹¤. ë°ì´í„° ì†ì‹¤, UI ë¶ˆì¼ì¹˜, í¬ë˜ì‹œ ë“± ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ë²„ê·¸ì˜ ì›ì¸ì´ ë˜ë¯€ë¡œ ë°˜ë“œì‹œ ë°©ì§€í•´ì•¼ í•œë‹¤.

## ğŸ” ìì„¸íˆ

### ê²½ìŸ ì¡°ê±´ì˜ ê¸°ë³¸ ì˜ˆì‹œ

```kotlin
// âŒ ê²½ìŸ ì¡°ê±´ ë°œìƒ: ë‘ ì½”ë£¨í‹´ì´ ë™ì‹œì— countë¥¼ ìˆ˜ì •
var count = 0

suspend fun unsafeIncrement() = coroutineScope {
    repeat(10_000) {
        launch(Dispatchers.Default) {
            count++ // Read -> Modify -> Writeê°€ ì›ìì ì´ì§€ ì•ŠìŒ
        }
    }
}
// ì˜ˆìƒ: 10000, ì‹¤ì œ: ë§¤ë²ˆ ë‹¤ë¥¸ ê°’ (ì˜ˆ: 9876, 9923, ...)

// count++ê°€ ë‚´ë¶€ì ìœ¼ë¡œ ìˆ˜í–‰í•˜ëŠ” ì‘ì—…:
// 1. count ê°’ ì½ê¸° (Read)   -> ìŠ¤ë ˆë“œA: 42 ì½ìŒ
// 2. 1 ë”í•˜ê¸° (Modify)      -> ìŠ¤ë ˆë“œB: 42 ì½ìŒ (ê°™ì€ ê°’!)
// 3. ê²°ê³¼ ì €ì¥ (Write)      -> ìŠ¤ë ˆë“œA: 43 ì €ì¥, ìŠ¤ë ˆë“œB: 43 ì €ì¥
// ê²°ê³¼: 2ë²ˆ ì¦ê°€í•´ì•¼ í•˜ì§€ë§Œ 1ë²ˆë§Œ ì¦ê°€í•¨
```

### Androidì—ì„œ í”í•œ ê²½ìŸ ì¡°ê±´ ì‹œë‚˜ë¦¬ì˜¤

```kotlin
// âŒ ViewModelì—ì„œì˜ ê²½ìŸ ì¡°ê±´
class BadViewModel : ViewModel() {
    private var items = mutableListOf<Item>()

    fun addItem(item: Item) {
        viewModelScope.launch(Dispatchers.IO) {
            val savedItem = repository.save(item)
            items.add(savedItem) // ì—¬ëŸ¬ ì½”ë£¨í‹´ì´ ë™ì‹œì— í˜¸ì¶œí•˜ë©´ ConcurrentModificationException!
        }
    }

    fun removeItem(id: String) {
        viewModelScope.launch(Dispatchers.IO) {
            repository.delete(id)
            items.removeAll { it.id == id } // ë™ì‹œ ì ‘ê·¼ ìœ„í—˜
        }
    }
}
```

### í•´ê²° ë°©ë²• 1: Mutex (ì½”ë£¨í‹´ ë½)

```kotlin
class SafeViewModel : ViewModel() {
    private val mutex = Mutex()
    private var items = mutableListOf<Item>()

    fun addItem(item: Item) {
        viewModelScope.launch(Dispatchers.IO) {
            val savedItem = repository.save(item)
            mutex.withLock {
                items.add(savedItem) // í•œ ë²ˆì— í•˜ë‚˜ì˜ ì½”ë£¨í‹´ë§Œ ì ‘ê·¼
            }
        }
    }
}
```

### í•´ê²° ë°©ë²• 2: ë‹¨ì¼ ìŠ¤ë ˆë“œ í•œì • (Thread Confinement)

```kotlin
class ConfinedViewModel : ViewModel() {
    // ìƒíƒœ ë³€ê²½ì„ ë‹¨ì¼ ìŠ¤ë ˆë“œë¡œ í•œì •
    private val stateDispatcher = Dispatchers.Main.immediate
    private var items = mutableListOf<Item>()

    fun addItem(item: Item) {
        viewModelScope.launch {
            val savedItem = withContext(Dispatchers.IO) {
                repository.save(item)
            }
            // ìƒíƒœ ë³€ê²½ì€ í•­ìƒ ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ (ë‹¨ì¼ ìŠ¤ë ˆë“œ í•œì •)
            withContext(stateDispatcher) {
                items.add(savedItem)
            }
        }
    }
}
```

### í•´ê²° ë°©ë²• 3: StateFlowì™€ update

```kotlin
class FlowViewModel : ViewModel() {
    private val _items = MutableStateFlow<List<Item>>(emptyList())
    val items: StateFlow<List<Item>> = _items.asStateFlow()

    fun addItem(item: Item) {
        viewModelScope.launch(Dispatchers.IO) {
            val savedItem = repository.save(item)
            _items.update { currentList ->
                // updateëŠ” ì›ìì ìœ¼ë¡œ ìƒíƒœë¥¼ ë³€ê²½ (CAS ê¸°ë°˜)
                currentList + savedItem
            }
        }
    }

    fun removeItem(id: String) {
        viewModelScope.launch(Dispatchers.IO) {
            repository.delete(id)
            _items.update { currentList ->
                currentList.filter { it.id != id }
            }
        }
    }
}
```

### í•´ê²° ë°©ë²• 4: AtomicReference / Atomic íƒ€ì…

```kotlin
import java.util.concurrent.atomic.AtomicInteger
import java.util.concurrent.atomic.AtomicReference

// ì›ìì  ì¹´ìš´í„°
val atomicCount = AtomicInteger(0)

suspend fun safeIncrement() = coroutineScope {
    repeat(10_000) {
        launch(Dispatchers.Default) {
            atomicCount.incrementAndGet() // ì›ìì  ì—°ì‚°
        }
    }
}
// í•­ìƒ ì •í™•íˆ 10000

// ì›ìì  ì°¸ì¡°ë¡œ ë¶ˆë³€ ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬
val atomicList = AtomicReference<List<Item>>(emptyList())

fun addItemAtomic(item: Item) {
    atomicList.updateAndGet { current -> current + item }
}
```

### í•´ê²° ë°©ë²• 5: Channelì„ ì´ìš©í•œ ì•¡í„° íŒ¨í„´

```kotlin
// ìƒíƒœ ë³€ê²½ ë©”ì‹œì§€ë¥¼ Channelë¡œ ì§ë ¬í™”
sealed class ItemAction {
    data class Add(val item: Item) : ItemAction()
    data class Remove(val id: String) : ItemAction()
}

class ActorViewModel : ViewModel() {
    private val actions = Channel<ItemAction>(Channel.UNLIMITED)
    private val _items = MutableStateFlow<List<Item>>(emptyList())

    init {
        // ë‹¨ì¼ ì½”ë£¨í‹´ì—ì„œ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬ -> ê²½ìŸ ì¡°ê±´ ì›ì²œ ì°¨ë‹¨
        viewModelScope.launch {
            for (action in actions) {
                when (action) {
                    is ItemAction.Add -> _items.value = _items.value + action.item
                    is ItemAction.Remove -> _items.value = _items.value.filter { it.id != action.id }
                }
            }
        }
    }

    fun addItem(item: Item) {
        viewModelScope.launch {
            val saved = withContext(Dispatchers.IO) { repository.save(item) }
            actions.send(ItemAction.Add(saved))
        }
    }
}
```

## ğŸ”— ê´€ë ¨ ê°œë…

- [[00-CS-ê¸°ì´ˆ/ë™ì‹œì„±/ë®¤í…ìŠ¤-ì„¸ë§ˆí¬ì–´|ë®¤í…ìŠ¤ì™€ ì„¸ë§ˆí¬ì–´]]
- [[00-CS-ê¸°ì´ˆ/ë™ì‹œì„±/êµì°©ìƒíƒœ-ë°ë“œë½|êµì°©ìƒíƒœ (ë°ë“œë½)]]
- [[00-CS-ê¸°ì´ˆ/ë™ì‹œì„±/í”„ë¡œì„¸ìŠ¤-vs-ìŠ¤ë ˆë“œ|í”„ë¡œì„¸ìŠ¤ vs ìŠ¤ë ˆë“œ]]
- [[00-CS-ê¸°ì´ˆ/ë™ì‹œì„±/ë™ì‹œì„±-vs-ë³‘ë ¬ì„±|ë™ì‹œì„± vs ë³‘ë ¬ì„±]]

## ğŸ“š ë” ë³´ê¸°

- [Shared Mutable State and Concurrency](https://kotlinlang.org/docs/shared-mutable-state-and-concurrency.html)
- [StateFlow and SharedFlow](https://developer.android.com/kotlin/flow/stateflow-and-sharedflow)

---

**í•µì‹¬ ìš”ì•½:** ê²½ìŸ ì¡°ê±´ì€ ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ê³µìœ  ìì›ì— ë™ì‹œ ì ‘ê·¼í•  ë•Œ ì‹¤í–‰ ìˆœì„œì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§€ëŠ” ë²„ê·¸ë¡œ, Androidì—ì„œëŠ” Mutex, StateFlow.update, ë‹¨ì¼ ìŠ¤ë ˆë“œ í•œì •, ì•¡í„° íŒ¨í„´ ë“±ìœ¼ë¡œ ë°©ì§€í•  ìˆ˜ ìˆë‹¤.