---
tags: [CS, ë™ì‹œì„±, ë°ë“œë½, êµì°©ìƒíƒœ, Android]
---

# êµì°©ìƒíƒœ (ë°ë“œë½)

## ğŸ’¡ í•µì‹¬ ê°œë…

**êµì°©ìƒíƒœ(Deadlock)**ëŠ” ë‘˜ ì´ìƒì˜ ìŠ¤ë ˆë“œ(ë˜ëŠ” ì½”ë£¨í‹´)ê°€ ì„œë¡œê°€ ì ìœ í•œ ìì›ì„ ê¸°ë‹¤ë¦¬ë©° ë¬´í•œíˆ ëŒ€ê¸°í•˜ëŠ” ìƒíƒœì´ë‹¤. ê° ìŠ¤ë ˆë“œê°€ ìƒëŒ€ë°©ì´ ê°€ì§„ ë½ì„ ìš”ì²­í•˜ë©´ì„œ ì–´ëŠ ìª½ë„ ì§„í–‰í•  ìˆ˜ ì—†ê²Œ ëœë‹¤. Androidì—ì„œëŠ” ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œì˜ `runBlocking` í˜¸ì¶œì´ë‚˜ ì˜ëª»ëœ ë½ ìˆœì„œê°€ ëŒ€í‘œì ì¸ ë°ë“œë½ ì›ì¸ì´ë‹¤.

## ğŸ“Œ ì™œ í•„ìš”í•œê°€?

Android ì•±ì—ì„œ ë°ë“œë½ì´ ë°œìƒí•˜ë©´ UIê°€ ì™„ì „íˆ ë©ˆì¶”ê³  ANRë¡œ ì´ì–´ì§„ë‹¤. íŠ¹íˆ ë©”ì¸ ìŠ¤ë ˆë“œì™€ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ ê°„ì˜ ë™ê¸°í™” ì½”ë“œì—ì„œ í”íˆ ë°œìƒí•˜ë¯€ë¡œ, ë°ë“œë½ì˜ ë°œìƒ ì¡°ê±´ê³¼ ì˜ˆë°©ë²•ì„ ë°˜ë“œì‹œ ì•Œì•„ì•¼ í•œë‹¤.

## ğŸ” ìì„¸íˆ

### ë°ë“œë½ ë°œìƒì˜ 4ê°€ì§€ í•„ìˆ˜ ì¡°ê±´

ë°ë“œë½ì€ ë‹¤ìŒ 4ê°€ì§€ ì¡°ê±´ì´ **ëª¨ë‘** ì¶©ì¡±ë  ë•Œ ë°œìƒí•œë‹¤ (Coffman ì¡°ê±´):

1. **ìƒí˜¸ ë°°ì œ (Mutual Exclusion)**: ìì›ì€ í•œ ë²ˆì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ì‚¬ìš© ê°€ëŠ¥
2. **ì ìœ ì™€ ëŒ€ê¸° (Hold and Wait)**: ìì›ì„ ì ìœ í•œ ì±„ ë‹¤ë¥¸ ìì›ì„ ëŒ€ê¸°
3. **ë¹„ì„ ì  (No Preemption)**: ë‹¤ë¥¸ ìŠ¤ë ˆë“œì˜ ìì›ì„ ê°•ì œë¡œ ëºì„ ìˆ˜ ì—†ìŒ
4. **ìˆœí™˜ ëŒ€ê¸° (Circular Wait)**: ìŠ¤ë ˆë“œë“¤ì´ ìˆœí™˜ í˜•íƒœë¡œ ìì›ì„ ëŒ€ê¸°

### ì „í˜•ì ì¸ ë°ë“œë½ ì˜ˆì‹œ

```kotlin
val lockA = Any()
val lockB = Any()

// ìŠ¤ë ˆë“œ1: lockA -> lockB ìˆœì„œë¡œ íšë“
thread {
    synchronized(lockA) {
        Thread.sleep(100) // íƒ€ì´ë°ì— ë”°ë¼ ë°ë“œë½
        synchronized(lockB) {
            println("ìŠ¤ë ˆë“œ1 ì™„ë£Œ")
        }
    }
}

// ìŠ¤ë ˆë“œ2: lockB -> lockA ìˆœì„œë¡œ íšë“ (ì—­ìˆœ!)
thread {
    synchronized(lockB) {
        Thread.sleep(100)
        synchronized(lockA) { // lockAëŠ” ìŠ¤ë ˆë“œ1ì´ ì ìœ  ì¤‘ -> ë°ë“œë½!
            println("ìŠ¤ë ˆë“œ2 ì™„ë£Œ")
        }
    }
}
// ë‘ ìŠ¤ë ˆë“œ ëª¨ë‘ ì˜ì›íˆ ëŒ€ê¸°
```

### Androidì—ì„œ í”í•œ ë°ë“œë½: runBlocking

```kotlin
// âŒ ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ runBlocking - ë°ë“œë½ ë°œìƒ!
class BadActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // runBlockingì€ í˜„ì¬ ìŠ¤ë ˆë“œ(ë©”ì¸)ë¥¼ ë¸”ë¡œí‚¹
        val result = runBlocking {
            withContext(Dispatchers.Main) {
                // ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰í•˜ë ¤ í•˜ì§€ë§Œ,
                // ë©”ì¸ ìŠ¤ë ˆë“œëŠ” runBlockingì— ì˜í•´ ì´ë¯¸ ë¸”ë¡œí‚¹ë¨
                // -> ë°ë“œë½!
                "data"
            }
        }
    }
}

// âœ… ì˜¬ë°”ë¥¸ ë°©ë²•: lifecycleScope ì‚¬ìš©
class GoodActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        lifecycleScope.launch {
            val result = withContext(Dispatchers.IO) {
                fetchData()
            }
            textView.text = result // ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ì•ˆì „í•˜ê²Œ ì‹¤í–‰
        }
    }
}
```

### ì½”ë£¨í‹´ì—ì„œì˜ ë°ë“œë½

```kotlin
// âŒ Mutexì˜ ì˜ëª»ëœ ì¤‘ì²© ì‚¬ìš© - ë°ë“œë½
val mutex = Mutex()

suspend fun dangerousFunction() {
    mutex.withLock {
        // ì´ë¯¸ ë½ì„ íšë“í•œ ìƒíƒœì—ì„œ ë‹¤ì‹œ ë½ ìš”ì²­
        mutex.withLock { // MutexëŠ” ì¬ì§„ì… ë¶ˆê°€ -> ë°ë“œë½!
            println("ì´ ì½”ë“œëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠìŒ")
        }
    }
}

// âœ… í•´ê²°: êµ¬ì¡° ë³€ê²½ ë˜ëŠ” ë‹¨ì¼ ë½ ì‚¬ìš©
suspend fun safeFunction() {
    mutex.withLock {
        // ë½ ë‚´ë¶€ì—ì„œ ë™ì¼í•œ ë½ì„ ë‹¤ì‹œ ìš”ì²­í•˜ì§€ ì•ŠìŒ
        doWork()
    }
}
```

### ë°ë“œë½ ì˜ˆë°© ì „ëµ

```kotlin
// ì „ëµ 1: ë½ ìˆœì„œë¥¼ í•­ìƒ ë™ì¼í•˜ê²Œ ìœ ì§€
val lockA = Mutex()
val lockB = Mutex()

suspend fun safeTransaction() {
    // í•­ìƒ lockA -> lockB ìˆœì„œë¡œ íšë“ (ìˆœí™˜ ëŒ€ê¸° ì œê±°)
    lockA.withLock {
        lockB.withLock {
            performTransaction()
        }
    }
}

// ì „ëµ 2: íƒ€ì„ì•„ì›ƒ ì„¤ì •
suspend fun withTimeout() {
    val acquired = withTimeoutOrNull(1000) {
        mutex.lock()
        try {
            doWork()
        } finally {
            mutex.unlock()
        }
    }
    if (acquired == null) {
        // íƒ€ì„ì•„ì›ƒ -> ë°ë“œë½ íšŒí”¼
        handleTimeout()
    }
}

// ì „ëµ 3: ë‹¨ì¼ ìŠ¤ë ˆë“œë¡œ ë™ì‹œì„± ì œí•œ (ìì› ê²©ë¦¬)
val singleThreadContext = newSingleThreadContext("DBThread")

suspend fun dbOperation() {
    withContext(singleThreadContext) {
        // ë‹¨ì¼ ìŠ¤ë ˆë“œì—ì„œ ìˆœì°¨ ì‹¤í–‰ë˜ë¯€ë¡œ ë°ë“œë½ ë¶ˆê°€
        database.update(data)
    }
}
```

### StrictModeë¡œ ë°ë“œë½ ê°ì§€

```kotlin
// ë””ë²„ê·¸ ë¹Œë“œì—ì„œ ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡œí‚¹ ê°ì§€
if (BuildConfig.DEBUG) {
    StrictMode.setThreadPolicy(
        StrictMode.ThreadPolicy.Builder()
            .detectAll()
            .penaltyLog()
            .penaltyDeath() // ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡œí‚¹ ì‹œ í¬ë˜ì‹œ
            .build()
    )
}
```

## ğŸ”— ê´€ë ¨ ê°œë…

- [[00-CS-ê¸°ì´ˆ/ë™ì‹œì„±/ê²½ìŸ-ì¡°ê±´|ê²½ìŸ ì¡°ê±´]]
- [[00-CS-ê¸°ì´ˆ/ë™ì‹œì„±/ë®¤í…ìŠ¤-ì„¸ë§ˆí¬ì–´|ë®¤í…ìŠ¤ì™€ ì„¸ë§ˆí¬ì–´]]
- [[00-CS-ê¸°ì´ˆ/ë™ì‹œì„±/í”„ë¡œì„¸ìŠ¤-vs-ìŠ¤ë ˆë“œ|í”„ë¡œì„¸ìŠ¤ vs ìŠ¤ë ˆë“œ]]
- [[00-CS-ê¸°ì´ˆ/ë™ì‹œì„±/ë¸”ë¡œí‚¹-vs-ë…¼ë¸”ë¡œí‚¹|ë¸”ë¡œí‚¹ vs ë…¼ë¸”ë¡œí‚¹]]

## ğŸ“š ë” ë³´ê¸°

- [Kotlin Coroutines: Shared Mutable State](https://kotlinlang.org/docs/shared-mutable-state-and-concurrency.html)
- [Android StrictMode](https://developer.android.com/reference/android/os/StrictMode)

---

**í•µì‹¬ ìš”ì•½:** ë°ë“œë½ì€ ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ì„œë¡œì˜ ìì›ì„ ê¸°ë‹¤ë¦¬ë©° ë¬´í•œ ëŒ€ê¸°í•˜ëŠ” ìƒíƒœë¡œ, Androidì—ì„œëŠ” ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œì˜ runBlocking ì‚¬ìš©ì„ í”¼í•˜ê³ , ë½ ìˆœì„œë¥¼ í†µì¼í•˜ë©°, êµ¬ì¡°í™”ëœ ë™ì‹œì„±ì„ í™œìš©í•˜ì—¬ ì˜ˆë°©í•´ì•¼ í•œë‹¤.