---
tags: [cs, memory, memory-leak, android, leakcanary]
---

# ë©”ëª¨ë¦¬ ë¦­

## ğŸ’¡ í•µì‹¬ ê°œë…

**ë©”ëª¨ë¦¬ ë¦­**(Memory Leak)ì€ ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê°ì²´ê°€ GCì— ì˜í•´ í•´ì œë˜ì§€ ëª»í•˜ê³  ë©”ëª¨ë¦¬ì— ê³„ì† ë‚¨ì•„ìˆëŠ” í˜„ìƒì´ë‹¤. ì°¸ì¡° ì²´ì¸ì´ ëŠì–´ì§€ì§€ ì•Šì•„ GCê°€ "ì•„ì§ ì‚¬ìš© ì¤‘"ì´ë¼ê³  íŒë‹¨í•˜ê¸° ë•Œë¬¸ì— ë°œìƒí•œë‹¤.

## ğŸ“Œ ì™œ í•„ìš”í•œê°€?

Android ì•±ì—ì„œ ë©”ëª¨ë¦¬ ë¦­ì€ OOM í¬ë˜ì‹œ, UI ë²„ë²…ì„ì˜ ì£¼ìš” ì›ì¸ì´ë‹¤. Activity/Fragment ë¦­ì€ ìˆ˜ë°± MBì˜ ë©”ëª¨ë¦¬ë¥¼ ë‚­ë¹„í•  ìˆ˜ ìˆë‹¤.

## ğŸ” ìì„¸íˆ

### Androidì—ì„œ í”í•œ ë©”ëª¨ë¦¬ ë¦­ íŒ¨í„´

**1. Activity/Context ë¦­ - ê°€ì¥ í”í•¨**

```kotlin
// âŒ BAD - Singletonì´ Activity ì°¸ì¡°ë¥¼ ë³´ìœ 
object Analytics {
    private lateinit var context: Context
    fun init(context: Context) {
        this.context = context  // Activityê°€ ì „ë‹¬ë˜ë©´ ë¦­!
    }
}

// âœ… GOOD - Application Context ì‚¬ìš©
object Analytics {
    private lateinit var context: Context
    fun init(context: Context) {
        this.context = context.applicationContext
    }
}
```

**2. ë‚´ë¶€ í´ë˜ìŠ¤ (Inner Class) ë¦­**

```kotlin
// âŒ BAD - ìµëª… ë‚´ë¶€ í´ë˜ìŠ¤ê°€ Activity ì°¸ì¡°
class MyActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        val handler = Handler(Looper.getMainLooper())
        handler.postDelayed({
            // ì´ ëŒë‹¤ê°€ MyActivityë¥¼ ì•”ë¬µì ìœ¼ë¡œ ì°¸ì¡°
            updateUI()
        }, 60_000) // 60ì´ˆ í›„ ì‹¤í–‰ â†’ ê·¸ ì „ì— Activity ì¢…ë£Œë˜ë©´ ë¦­
    }
}

// âœ… GOOD - WeakReference ë˜ëŠ” lifecycleScope ì‚¬ìš©
class MyActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        lifecycleScope.launch {
            delay(60_000)
            updateUI() // Activity ì¢…ë£Œ ì‹œ ì½”ë£¨í‹´ ìë™ ì·¨ì†Œ
        }
    }
}
```

**3. Listener/Callback ë“±ë¡ í•´ì œ ëˆ„ë½**

```kotlin
// âŒ BAD - ë“±ë¡ë§Œ í•˜ê³  í•´ì œ ì•ˆ í•¨
class MyFragment : Fragment() {
    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        SensorManager.registerListener(sensorListener, sensor, DELAY)
    }
    // onDestroyViewì—ì„œ unregister ì•ˆ í•¨ â†’ ë¦­
}

// âœ… GOOD
class MyFragment : Fragment() {
    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        SensorManager.registerListener(sensorListener, sensor, DELAY)
    }
    override fun onDestroyView() {
        super.onDestroyView()
        SensorManager.unregisterListener(sensorListener)
    }
}
```

**4. ì½”ë£¨í‹´ ìŠ¤ì½”í”„ ë¦­**

```kotlin
// âŒ BAD - GlobalScopeëŠ” ì•± ì „ì²´ ìˆ˜ëª…
class MyViewModel : ViewModel() {
    fun fetchData() {
        GlobalScope.launch { /* ... */ }  // ViewModel ì¢…ë£Œ í›„ì—ë„ ì‹¤í–‰ë¨
    }
}

// âœ… GOOD - viewModelScope ì‚¬ìš©
class MyViewModel : ViewModel() {
    fun fetchData() {
        viewModelScope.launch { /* ViewModel ì¢…ë£Œ ì‹œ ìë™ ì·¨ì†Œ */ }
    }
}
```

### LeakCanaryë¡œ ë¦­ íƒì§€

```groovy
// build.gradle.kts
dependencies {
    debugImplementation("com.squareup.leakcanary:leakcanary-android:2.14")
}
// ì„¤ì • ë! ë””ë²„ê·¸ ë¹Œë“œì—ì„œ ë¦­ ë°œìƒ ì‹œ ì•Œë¦¼ í‘œì‹œ
```

### ë©”ëª¨ë¦¬ ë¦­ ë””ë²„ê¹…

```
Android Studio â†’ Profiler â†’ Memory
1. Heap Dump ìº¡ì²˜
2. "Leaked Activities" í•„í„°
3. ì°¸ì¡° ì²´ì¸(Reference Chain) ë¶„ì„
   â†’ ì–´ë–¤ ê°ì²´ê°€ Activityë¥¼ ë¶™ì¡ê³  ìˆëŠ”ì§€ í™•ì¸
```

### ë¦­ ë°©ì§€ ì²´í¬ë¦¬ìŠ¤íŠ¸

```
âœ… ContextëŠ” ê°€ëŠ¥í•œ í•œ applicationContext ì‚¬ìš©
âœ… ì½”ë£¨í‹´ì€ lifecycleScope / viewModelScope ì‚¬ìš©
âœ… Listener, Callback, ObserverëŠ” ë°˜ë“œì‹œ í•´ì œ
âœ… ë‚´ë¶€ í´ë˜ìŠ¤ë³´ë‹¤ static í´ë˜ìŠ¤ + WeakReference
âœ… Bitmapì€ ì‚¬ìš© í›„ recycle() ë˜ëŠ” ì´ë¯¸ì§€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©
âœ… Fragmentì˜ View ì°¸ì¡°ëŠ” onDestroyViewì—ì„œ null ì²˜ë¦¬
```

## ğŸ”— ê´€ë ¨ ê°œë…

- [[00-CS-ê¸°ì´ˆ/JVM/GC-ê°€ë¹„ì§€-ì»¬ë ‰ì…˜|GC ê°€ë¹„ì§€ ì»¬ë ‰ì…˜]]
- [[00-CS-ê¸°ì´ˆ/ë©”ëª¨ë¦¬/ìŠ¤íƒ-vs-í™|ìŠ¤íƒ vs í™]]
- [[00-CS-ê¸°ì´ˆ/JVM/JVM-êµ¬ì¡°|JVM êµ¬ì¡°]]

## ğŸ“š ë” ë³´ê¸°

- [LeakCanary](https://square.github.io/leakcanary/)
- [Android Memory Profiler](https://developer.android.com/studio/profile/memory-profiler)

---

**í•µì‹¬ ìš”ì•½:** ë©”ëª¨ë¦¬ ë¦­ì€ ì°¸ì¡°ê°€ ëŠì–´ì§€ì§€ ì•Šì•„ GCê°€ ìˆ˜ê±° ëª»í•˜ëŠ” í˜„ìƒ. Androidì—ì„œëŠ” Activity Context ë¦­, ë¦¬ìŠ¤ë„ˆ ë¯¸í•´ì œ, GlobalScope ì‚¬ìš©ì´ ì£¼ìš” ì›ì¸. LeakCanaryë¡œ ìë™ íƒì§€ ê°€ëŠ¥.
