---
tags: [cs, compile, kotlin, jvm]
---

# 컴파일 과정

## 💡 핵심 개념

**컴파일**은 사람이 읽는 소스 코드를 기계가 실행할 수 있는 형태로 변환하는 과정이다. Kotlin/Android에서는 `.kt` → `.class` → `.dex` → `.apk` 순으로 변환된다.

## 📌 왜 필요한가?

빌드 에러, 어노테이션 프로세싱(kapt/ksp), ProGuard, 빌드 최적화 등을 이해하려면 컴파일 과정을 알아야 한다. "컴파일 타임에 잡아준다"는 말이 정확히 어떤 시점인지 이해할 수 있다.

## 🔍 자세히

### Kotlin/Android 빌드 파이프라인

```
[소스 코드]  .kt / .java
     │
     ▼
[어노테이션 프로세싱]  kapt / ksp
     │  → 코드 생성 (Dagger, Room, Moshi 등)
     ▼
[Kotlin 컴파일러]  kotlinc
     │  → .class (JVM 바이트코드)
     ▼
[Java 컴파일러]  javac (Java 소스가 있는 경우)
     │  → .class
     ▼
[D8/R8 컴파일러]
     │  → .dex (Dalvik 바이트코드)
     │  → R8: 난독화 + 최적화 + 트리 쉐이킹
     ▼
[APK 패키징]
     │  → 리소스 + DEX + 네이티브 라이브러리 + 매니페스트
     ▼
[서명]
     │  → 릴리즈 키 or 디버그 키
     ▼
[APK / AAB]  설치 가능한 최종 결과물
```

### 각 단계 설명

**1. 어노테이션 프로세싱 (kapt / ksp)**

컴파일 전에 어노테이션을 읽고 새로운 소스 코드를 생성하는 단계.

```kotlin
// @Entity 어노테이션을 Room이 읽고 → DAO 구현체 코드를 자동 생성
@Entity
data class User(
    @PrimaryKey val id: Int,
    val name: String
)

// 컴파일 시 자동 생성됨: User_Impl.java, UserDao_Impl.java 등
```

→ 자세한 내용은 [[00-CS-기초/컴파일과-런타임/kapt-vs-ksp|kapt vs ksp]] 참고

**2. Kotlin 컴파일러 (kotlinc)**

`.kt` 파일을 JVM 바이트코드(`.class`)로 변환한다.

```kotlin
// 소스 코드
data class User(val name: String)

// 컴파일러가 자동 생성하는 것들:
// - equals() / hashCode()
// - toString()
// - copy()
// - componentN()
```

**3. D8 / R8**

```
D8: .class → .dex 변환 (디버그 빌드)
R8: .class → .dex 변환 + 최적화 (릴리즈 빌드)
    - 코드 축소 (사용하지 않는 클래스/메서드 제거)
    - 난독화 (클래스/메서드명을 a, b, c로 변경)
    - 최적화 (인라이닝, 불필요한 코드 제거)
```

```groovy
// build.gradle.kts
android {
    buildTypes {
        release {
            isMinifyEnabled = true  // R8 활성화
            proguardFiles(getDefaultProguardFile("proguard-android-optimize.txt"))
        }
    }
}
```

**4. APK 패키징**

```
APK 구조:
├── classes.dex          // 컴파일된 코드
├── res/                 // 컴파일된 리소스
├── resources.arsc       // 리소스 테이블
├── lib/                 // 네이티브 라이브러리 (.so)
├── assets/              // raw 파일
├── AndroidManifest.xml  // 매니페스트
└── META-INF/            // 서명 정보
```

### 컴파일 타임 vs 런타임 에러

```kotlin
// 컴파일 타임 에러 - 빌드 자체가 안 됨
val x: Int = "hello"  // Type mismatch

// 런타임 에러 - 빌드는 되지만 실행 중 크래시
val list = listOf(1, 2, 3)
list[10]  // IndexOutOfBoundsException
```

### 증분 컴파일 (Incremental Compilation)

```
전체 컴파일: 모든 파일을 다시 컴파일 (느림)
증분 컴파일: 변경된 파일과 영향받는 파일만 다시 컴파일 (빠름)

Kotlin 컴파일러는 증분 컴파일을 지원한다.
kapt는 증분 컴파일 지원이 제한적 → ksp가 이를 개선.
```

## 🔗 관련 개념

- [[00-CS-기초/컴파일과-런타임/kapt-vs-ksp|kapt vs ksp]]
- [[00-CS-기초/컴파일과-런타임/바이트코드와-기계어|바이트코드와 기계어]]
- [[00-CS-기초/컴파일과-런타임/컴파일-타임-vs-런타임|컴파일 타임 vs 런타임]]
- [[00-CS-기초/JVM/JVM-구조|JVM 구조]]
- [[00-CS-기초/JVM/Dalvik-vs-ART|Dalvik vs ART]]

## 📚 더 보기

- [Kotlin Docs - Compiler](https://kotlinlang.org/docs/command-line.html)
- [Android Build Overview](https://developer.android.com/build)

---

**핵심 요약:** `.kt` → kotlinc → `.class` → D8/R8 → `.dex` → APK. 어노테이션 프로세싱은 컴파일 전에 코드를 생성. R8은 릴리즈 빌드에서 축소+난독화+최적화.
