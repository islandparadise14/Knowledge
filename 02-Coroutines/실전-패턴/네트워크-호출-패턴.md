# 네트워크 호출 패턴

> 코루틴을 활용한 안전하고 효율적인 네트워크 호출

## 기본 패턴

```kotlin
class UserRepository(
    private val api: UserApi
) {
    suspend fun getUser(id: String): Result<User> {
        return try {
            Result.success(api.getUser(id))
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

## ViewModel에서 호출

```kotlin
class UserViewModel(
    private val repository: UserRepository
) : ViewModel() {

    private val _uiState = MutableStateFlow<UiState>(UiState.Loading)
    val uiState: StateFlow<UiState> = _uiState.asStateFlow()

    fun loadUser(id: String) {
        viewModelScope.launch {
            _uiState.value = UiState.Loading

            repository.getUser(id)
                .onSuccess { user ->
                    _uiState.value = UiState.Success(user)
                }
                .onFailure { error ->
                    _uiState.value = UiState.Error(error.message)
                }
        }
    }
}
```

## 병렬 호출

```kotlin
suspend fun loadDashboard(): Dashboard = coroutineScope {
    val user = async { api.getUser() }
    val posts = async { api.getPosts() }
    val notifications = async { api.getNotifications() }

    Dashboard(
        user = user.await(),
        posts = posts.await(),
        notifications = notifications.await()
    )
}
```

## 재시도 패턴

```kotlin
suspend fun <T> retry(
    times: Int = 3,
    initialDelay: Long = 100,
    factor: Double = 2.0,
    block: suspend () -> T
): T {
    var currentDelay = initialDelay
    repeat(times - 1) {
        try {
            return block()
        } catch (e: Exception) {
            delay(currentDelay)
            currentDelay = (currentDelay * factor).toLong()
        }
    }
    return block()  // 마지막 시도
}
```

## 타임아웃

```kotlin
suspend fun fetchWithTimeout(): User? {
    return withTimeoutOrNull(5000) {
        api.getUser()
    }
}
```

## 취소 처리

```kotlin
fun loadData() {
    // 이전 작업 취소
    loadJob?.cancel()

    loadJob = viewModelScope.launch {
        // 새 작업 시작
    }
}
```

---

## 관련 문서
- [[02-Coroutines/빌더/Async-Await|async/await]]
- [[02-Coroutines/예외-처리/코루틴-예외-처리|코루틴 예외 처리]]
- [[08-네트워크/Retrofit/Retrofit-기초|Retrofit 기초]]

[← Coroutines](02-Coroutines/README.md)
