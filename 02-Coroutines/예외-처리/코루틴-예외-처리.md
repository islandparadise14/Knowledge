---
tags: [coroutines, exception-handling, error]
---

# ì½”ë£¨í‹´ ì˜ˆì™¸ ì²˜ë¦¬

## ğŸ’¡ í•µì‹¬ ê°œë…

ì½”ë£¨í‹´ì—ì„œ ì˜ˆì™¸ëŠ” ë¶€ëª¨ë¡œ ì „íŒŒëœë‹¤. **launch**ëŠ” ì¦‰ì‹œ ì „íŒŒí•˜ê³ , **async**ëŠ” await() ì‹œ ì „íŒŒí•œë‹¤. CoroutineExceptionHandlerë¡œ ì²˜ë¦¬ ê°€ëŠ¥í•˜ë‹¤.

## ğŸ“Œ ì™œ í•„ìš”í•œê°€?

ì¼ë°˜ì ì¸ try-catchë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í•˜ë‹¤. ë¶€ëª¨-ìì‹ ê´€ê³„, Job ì·¨ì†Œ, ì˜ˆì™¸ ì „íŒŒ ë©”ì»¤ë‹ˆì¦˜ì„ ì´í•´í•´ì•¼ í•œë‹¤.

## ğŸ” ìì„¸íˆ

### launch vs async ì˜ˆì™¸

```kotlin
// launch - ì¦‰ì‹œ ì˜ˆì™¸ ì „íŒŒ
val job = launch {
    throw Exception("Error!")
}
// ì˜ˆì™¸ê°€ ì¦‰ì‹œ ë°œìƒ (catch ì•ˆ ë¨)

// async - await() ì‹œ ì˜ˆì™¸ ì „íŒŒ
val deferred = async {
    throw Exception("Error!")
}

try {
    deferred.await()  // ì—¬ê¸°ì„œ ì˜ˆì™¸ ë°œìƒ
} catch (e: Exception) {
    println("Caught: $e")
}
```

### try-catch

```kotlin
// ì‘ë™í•¨
viewModelScope.launch {
    try {
        val data = fetchData()
    } catch (e: Exception) {
        println("Error: $e")
    }
}

// ì‘ë™ ì•ˆ í•¨ - launch ë°–ì—ì„œ
try {
    viewModelScope.launch {
        throw Exception("Error!")
    }
} catch (e: Exception) {
    // ì—¬ê¸° ì•ˆ ì˜´!
}
```

### CoroutineExceptionHandler

```kotlin
val handler = CoroutineExceptionHandler { _, exception ->
    println("Caught $exception")
}

// launchì˜ contextì— ì¶”ê°€
val job = launch(handler) {
    throw Exception("Error!")
}
// "Caught java.lang.Exception: Error!" ì¶œë ¥

// asyncëŠ” ì‘ë™ ì•ˆ í•¨
val deferred = async(handler) {
    throw Exception("Error!")
}
// await() ì‹œ ì˜ˆì™¸ ë°œìƒ
```

### SupervisorJob

```kotlin
// ì¼ë°˜ Job - ìì‹ í•˜ë‚˜ ì‹¤íŒ¨í•˜ë©´ ëª¨ë‘ ì·¨ì†Œ
val scope = CoroutineScope(Job())

scope.launch {
    launch {
        throw Exception("Child 1")  // ì—¬ê¸°ì„œ ì‹¤íŒ¨
    }
    launch {
        delay(1000)
        println("Child 2")  // ì‹¤í–‰ ì•ˆ ë¨ (ì·¨ì†Œë¨)
    }
}

// SupervisorJob - ìì‹ í•˜ë‚˜ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ìì‹ ê³„ì†
val scope = CoroutineScope(SupervisorJob())

scope.launch {
    launch {
        throw Exception("Child 1")  // ì‹¤íŒ¨
    }
    launch {
        delay(1000)
        println("Child 2")  // ì •ìƒ ì‹¤í–‰
    }
}
```

### supervisorScope

```kotlin
suspend fun loadData() = supervisorScope {
    val user = async { fetchUser() }
    val posts = async { 
        throw Exception("Posts error")  // ì‹¤íŒ¨
    }
    
    try {
        user.await()  // ì„±ê³µ
    } catch (e: Exception) {
        // user ì˜ˆì™¸ ì²˜ë¦¬
    }
    
    try {
        posts.await()
    } catch (e: Exception) {
        println("Posts failed: $e")  // ì—¬ê¸°ì„œ ì²˜ë¦¬
    }
}
```

### CancellationException íŠ¹ë³„ ì²˜ë¦¬

```kotlin
launch {
    try {
        delay(1000)
    } catch (e: CancellationException) {
        println("Cancelled")
        throw e  // ë°˜ë“œì‹œ ë‹¤ì‹œ ë˜ì ¸ì•¼ í•¨!
    } catch (e: Exception) {
        println("Error")
    }
}
```

### ë™ì‘ ì›ë¦¬

**ì˜ˆì™¸ ì „íŒŒ ë©”ì»¤ë‹ˆì¦˜**

```
Child Job throws Exception
    â†“
Parent Job cancels
    â†“
All sibling Jobs cancel
    â†“
CoroutineExceptionHandler (if any)
    â†“
Thread.uncaughtExceptionHandler
```

**SupervisorJob vs Job**

```kotlin
// Job - ì–‘ë°©í–¥ ì „íŒŒ
Parent Job
  â”œâ”€ Child 1 (fails) â†’ Parent fails â†’ All cancel
  â”œâ”€ Child 2 (cancelled)
  â””â”€ Child 3 (cancelled)

// SupervisorJob - ë‹¨ë°©í–¥ë§Œ
Parent SupervisorJob
  â”œâ”€ Child 1 (fails) â†’ Only Child 1 fails
  â”œâ”€ Child 2 (continues)
  â””â”€ Child 3 (continues)
```

### ì£¼ì˜ì‚¬í•­

**1. CoroutineExceptionHandlerëŠ” launchë§Œ**

```kotlin
val handler = CoroutineExceptionHandler { _, exception ->
    println("Caught: $exception")
}

// ì‘ë™í•¨
launch(handler) { throw Exception() }

// ì‘ë™ ì•ˆ í•¨
async(handler) { throw Exception() }
```

**2. ìì‹ scopeì˜ handlerëŠ” ë¬´ì‹œ**

```kotlin
val handler = CoroutineExceptionHandler { _, exception ->
    println("Caught: $exception")
}

launch {
    // ì´ handlerëŠ” ë¬´ì‹œë¨
    launch(handler) {
        throw Exception()
    }
}
```

**3. CancellationExceptionì€ ì¬throw**

```kotlin
try {
    someSuspendFunction()
} catch (e: CancellationException) {
    // ì •ë¦¬ ì‘ì—…
    cleanup()
    throw e  // í•„ìˆ˜!
} catch (e: Exception) {
    // ì¼ë°˜ ì˜ˆì™¸ ì²˜ë¦¬
}
```

**4. runCatchingì€ CancellationExceptionë„ ì¡ìŒ**

```kotlin
// ë‚˜ì¨ - CancellationExceptionë„ ì¡í˜
val result = runCatching {
    delay(1000)
}

// ì¢‹ìŒ - CancellationExceptionì€ ì œì™¸
suspend fun <T> runCatchingExceptCancel(
    block: suspend () -> T
): Result<T> {
    return try {
        Result.success(block())
    } catch (e: CancellationException) {
        throw e
    } catch (e: Exception) {
        Result.failure(e)
    }
}
```

## ğŸ’» ì‹¤ì „ ì˜ˆì œ

### ViewModel ì˜ˆì™¸ ì²˜ë¦¬

```kotlin
class UserViewModel : ViewModel() {
    private val _uiState = MutableStateFlow<UiState>(UiState.Initial)
    val uiState: StateFlow<UiState> = _uiState.asStateFlow()
    
    private val exceptionHandler = CoroutineExceptionHandler { _, exception ->
        _uiState.value = UiState.Error(exception.message ?: "Unknown error")
    }
    
    fun loadUser(id: String) {
        viewModelScope.launch(exceptionHandler) {
            _uiState.value = UiState.Loading
            val user = repository.getUser(id)
            _uiState.value = UiState.Success(user)
        }
    }
}
```

### Repository íŒ¨í„´

```kotlin
class UserRepository {
    suspend fun getUser(id: String): Result<User> {
        return try {
            Result.success(api.getUser(id))
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}

// ViewModel
fun loadUser(id: String) {
    viewModelScope.launch {
        repository.getUser(id)
            .onSuccess { user ->
                _uiState.value = UiState.Success(user)
            }
            .onFailure { error ->
                _uiState.value = UiState.Error(error.message)
            }
    }
}
```

### ë³‘ë ¬ ì‘ì—… ì˜ˆì™¸ ì²˜ë¦¬

```kotlin
suspend fun loadData() = supervisorScope {
    val users = async {
        try {
            fetchUsers()
        } catch (e: Exception) {
            emptyList()
        }
    }
    
    val posts = async {
        try {
            fetchPosts()
        } catch (e: Exception) {
            emptyList()
        }
    }
    
    Data(users.await(), posts.await())
}
```

### Retry ë¡œì§

```kotlin
suspend fun <T> retry(
    times: Int = 3,
    delay: Long = 1000,
    block: suspend () -> T
): T {
    repeat(times - 1) { attempt ->
        try {
            return block()
        } catch (e: Exception) {
            if (attempt == times - 2) throw e
            delay(delay)
        }
    }
    return block()
}

// ì‚¬ìš©
suspend fun fetchData() = retry(3) {
    api.getData()
}
```

### Flow ì˜ˆì™¸ ì²˜ë¦¬

```kotlin
fun getData(): Flow<Data> = flow {
    emit(fetchData())
}.catch { e ->
    println("Error: $e")
    emit(Data.Empty)
}.onCompletion { cause ->
    if (cause != null) {
        println("Completed with error: $cause")
    }
}
```

### ì—¬ëŸ¬ ì‘ì—… ì¤‘ ì¼ë¶€ ì‹¤íŒ¨ í—ˆìš©

```kotlin
suspend fun loadUserProfile(id: String) = supervisorScope {
    val user = async { fetchUser(id) }
    val posts = async { fetchPosts(id) }
    val followers = async { fetchFollowers(id) }
    
    UserProfile(
        user = user.await(),
        posts = posts.getOrNull() ?: emptyList(),
        followers = followers.getOrNull() ?: emptyList()
    )
}

suspend fun <T> Deferred<T>.getOrNull(): T? {
    return try {
        await()
    } catch (e: Exception) {
        null
    }
}
```

### GlobalExceptionHandler (ì•± ì „ì²´)

```kotlin
class MyApplication : Application() {
    override fun onCreate() {
        super.onCreate()
        
        Thread.setDefaultUncaughtExceptionHandler { _, throwable ->
            // ë¡œê¹…, í¬ë˜ì‹œ ë¦¬í¬íŒ…
            Log.e("App", "Uncaught exception", throwable)
        }
    }
}
```

## ğŸ”— ê´€ë ¨ ê°œë…

- [[02-Coroutines/êµ¬ì¡°í™”ëœ-ë™ì‹œì„±/SupervisorJob]]
- [[02-Coroutines/ë¹Œë”/Launch]]
- [[02-Coroutines/ë¹Œë”/Async-Await]]

## ğŸ“š ë” ë³´ê¸°

- [Kotlin Docs - Exception Handling](https://kotlinlang.org/docs/exception-handling.html)

---

**í•µì‹¬ ìš”ì•½:** launchëŠ” ì¦‰ì‹œ ì „íŒŒ, asyncëŠ” await ì‹œ. CoroutineExceptionHandlerë¡œ ì²˜ë¦¬. SupervisorJobìœ¼ë¡œ ë…ë¦½.
