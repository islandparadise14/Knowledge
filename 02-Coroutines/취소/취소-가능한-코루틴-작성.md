# 취소 가능한 코루틴 작성

> 코루틴 취소에 협조적으로 대응하는 방법

## 취소의 동작 원리

코루틴 취소는 **협조적**. `CancellationException`을 던져서 취소됨.

```kotlin
val job = launch {
    repeat(1000) { i ->
        println("작업 $i")
        delay(100)  // 취소 지점
    }
}

delay(500)
job.cancel()  // 취소 요청
```

## 취소 지점 (Suspension Points)

다음 함수들은 취소를 체크함:
- `delay()`
- `yield()`
- `withContext()`
- 기타 suspend 함수들

## 취소에 협조하기

### 방법 1: isActive 체크
```kotlin
launch {
    while (isActive) {  // 취소되면 false
        // CPU 집약적 작업
        heavyComputation()
    }
}
```

### 방법 2: ensureActive()
```kotlin
launch {
    repeat(1000) {
        ensureActive()  // 취소되면 CancellationException
        heavyComputation()
    }
}
```

### 방법 3: yield()
```kotlin
launch {
    repeat(1000) {
        yield()  // 취소 체크 + 다른 코루틴에 양보
        heavyComputation()
    }
}
```

## 리소스 정리

### try-finally
```kotlin
launch {
    try {
        work()
    } finally {
        // 취소되어도 실행됨
        cleanup()
    }
}
```

### NonCancellable
```kotlin
launch {
    try {
        work()
    } finally {
        withContext(NonCancellable) {
            // 취소 중에도 suspend 함수 호출 가능
            saveData()
        }
    }
}
```

## 타임아웃

```kotlin
withTimeout(3000) {
    // 3초 초과 시 TimeoutCancellationException
    fetchData()
}

// null 반환 버전
val result = withTimeoutOrNull(3000) {
    fetchData()
}
```

---

## 관련 문서
- [[02-Coroutines/빌더/Launch|launch]]
- [[02-Coroutines/예외-처리/코루틴-예외-처리|코루틴 예외 처리]]

[← Coroutines](02-Coroutines/README.md)
